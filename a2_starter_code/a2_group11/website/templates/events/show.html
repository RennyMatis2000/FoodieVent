{% extends "base.html" %}
<!--This is extending the basic layout already in base.html-->
{% from 'bootstrap5/form.html' import render_form, render_field %}
<!--Importing bootstrap 5 form -->
{% block content %}

<!--Event details page Jumbotron-->
<div class="p-5 detailjumbotronimage rounded-3" style="background-image: url('{{ event.image }}');">
  <div class="container-fluid py-5">
    <h1 class="display-5 fw-bold">Event Details</h1>
    <p class="col-md-8 fs-4">Are you interested about {{ event.title }}? Well we're excited to help you out. Please read
      below for more specific
      details and how to book tickets to attend {{ event.title }}.</p>
  </div>
</div>

<div class="container-flex">
  <!--Event details page title -->
  <div class="col-12 col-md-6 offset-md-3">
    <div class="row">
      <div>
        <h1 id="page-header" class="page-header">{{ event.title }}</h1>
      </div>
    </div>
  </div>

  <!-- Event details section  -->
  <div class="row">
    <div class="col-12 col-md-6 offset-md-3">
      <div id="event-detail-card" class="card my-3">
        <img src="{{ event.image }}" alt="{{ event.title }}" class="card-img-top">
        <div class="card-body event-card">

          <div class="card-body event-card">
            {% set category_badge = {
            'FOOD': 'bg-success',
            'DRINK': 'bg-primary',
            'CULTURAL': 'bg-warning',
            'DIETARY': 'bg-danger'
            }[event.category_type.name] %}
            <span class="badge {{category_badge }} mb-3">Event Category: {{ event.category_type.name }}</span>
            {% set status_badge = {
            'OPEN': 'bg-success',
            'INACTIVE': 'bg-secondary',
            'SOLDOUT': 'bg-warning',
            'CANCELLED': 'bg-danger'
            }[event.status.name] %}
            <span class="badge {{ status_badge }} mb-3">Event Status: {{ event.status.name }}</span>
            <span class="badge bg-info mb-3">Tickets Remaining: {{ event.total_tickets }}</span>
            <span class="badge bg-info mb-3">Price per ticket: ${{ event.ticket_price }}</span>
            <span class="badge bg-info mb-3">Start Time: {{ event.start_time.strftime('%Y-%m-%d %H:%M') }}</span>
            <span class="badge bg-info mb-3">End Time: {{ event.end_time.strftime('%Y-%m-%d %H:%M') }}</span>
            <h5 class="mt-2">{{ event.description }}</h5>
          </div>

          {% set can_book = (event.status.name == 'OPEN') %}
          {% set can_update = (current_user.id == event.creator_id) %}

          <div class="card-footer">
            <div class="row g-2">
              {% if can_book %}
              <div class="col">
                <button type="button" class="btn btn-success w-100" data-bs-toggle="modal"
                  data-bs-target="#bookTicketsModal">
                  Book Now
                </button>
              </div>
              {% endif %}

              {% if can_update %}
              <div class="col">
                <a href="{{ url_for('events.update', event_id=event.id) }}" class="btn btn-success w-100">
                  Update Event
                </a>
              </div>
              {% endif %}

              {% if not can_book and not can_update %}
              <div class="col-12">
                <p class="warning-text mb-0">
                  Event is unavailable for booking. View event status for details.
                </p>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Title of event status row-->
          <div class="row">
            <h2 class="detail-header"><i class="bi bi-clock me-2" aria-hidden="true"> <i class="bi bi-calendar-check-fill"></i></i> Date</h2>
            <p class="descriptive event-descriptive">
              {{ event.title }} will be held between {{ event.start_time }} to {{ event.end_time }}. We recommend early
              arrival, as events held at FoodieVent often have eager participants resulting in queueing on event
              entrances.
              For events that end late at night, it is recommended to prepare transport for your departure prior to the
              event.
            </p>

            <!-- Title of venue and vendors row-->
            <h2 class="detail-header"><i class="bi bi-buildings-fill"></i> <i class="bi bi-people-fill"></i> Venue and Vendors</h2>
            <p class="descriptive event-descriptive">{{event.title}} will be located at {{ event.venue }} where vendors
              {{
              event.vendor_names }} will be
              participating to provide you an
              excellent event.
            </p>
          </div>

          <!-- Title of tickets row-->
          <div class="row">
            <h2 class="detail-header"><i class="bi bi-ticket-fill"></i> Tickets</h2>
            <p class="descriptive event-descriptive">
              The tickets at {{ event.title }} cost ${{ event.ticket_price }}. There are {{ event.total_tickets}}
              available
              tickets remaining for purchase, if you wish to participate in {{ event.title }}.
            </p>

            <!-- Sampling in event row -->
            <div class="row">
              <h2 class="detail-header"><i class="bi bi-cookie"></i> Sampling</h2>
              {% if event.free_sampling %}
              <p class="descriptive event-descriptive">
                {{ event.title }} will be offering free sampling.
              </p>
              {% else %}
              <p class="descriptive event-descriptive">
                {{ event.title }} will not be offering free sampling.
              </p>
              {% endif %}
            </div>

            <!-- Takeaway in event row -->
            <div class="row">
              <h2 class="detail-header"><i class="bi bi-truck"></i> Takeaway</h2>
              {% if event.provide_takeaway %}
              <p class="descriptive event-descriptive">
                {{ event.title }} will be providing takeaway.
              </p>
              {% else %}
              <p class="descriptive event-descriptive">
                {{ event.title }} will not be providing takeaway.
              </p>
              {% endif %}
            </div>


            <!-- Book / Purchase modal (single) -->
            <div class="modal fade" id="bookTicketsModal" tabindex="-1" aria-labelledby="bookTicketsLabel"
              aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form id="purchaseForm" method="POST"
                    action="{{ url_for('events.purchase_tickets', event_id=event.id) }}">
                    <div class="modal-header">
                      <h3 class="modal-title" id="bookTicketsLabel">Book Order by Purchasing Tickets</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body">
                      {{ purchase_form.hidden_tag() }}

                      <div class="mb-3">
                        {{ render_field(purchase_form.tickets_purchased,
                        class="form-control",
                        id="tickets_purchased",
                        min="1",
                        max=event.total_tickets) }}
                        <div class="form-text mb-3">
                          Price per ticket: ${{ (event.ticket_price) }} | Tickets remaining: {{ event.total_tickets }}
                        </div>
                        <p class="warning-text mb-3">
                          Warning: Clicking "Confirm Purchase" will finalise the purchase of tickets and deduct money
                          for
                          your
                          payment.
                        </p>
                      </div>
                    </div>

                    <div class="modal-footer">
                      <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                      {{ purchase_form.submit(class="btn btn-success") }}
                      {# or:
                      <button type="submit" class="btn btn-success" name="{{ purchase_form.submit.name }}" value="1">
                        {{ purchase_form.submit.label.text }}
                      </button>
                      #}
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <hr id="comments">

            <!-- Comment section -->
            <div class="row">
              <div class="col-12">
                <h2>
                  {{ render_form(form, action=url_for('events.comment', event_id=event.id), button_map={"submit":
                  "success"})
                  }}
                </h2>
              </div>
            </div>

            <!-- Comment flashes (only for comment-related categories) -->
            {% with messages = get_flashed_messages(with_categories=true, category_filter=['comment', 'comment-error'])
            %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert {{ 'alert-success' if category == 'comment' }}" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <div class="row">
              <div class="col-12">
                {% for comment in event.comments %}
                <div class="border-bottom comment-border pb-3 mb-3 px-3 py-2 rounded">
                  <b>
                    <p>
                      Comment #{{ comment.id }} on FoodieVent.
                      <span class="ms-2 text-muted">Posted at {{ comment.comment_date.strftime('%Y-%m-%d %H:%M')
                        }}</span>
                    </p>
                    User â€” {{ comment.user.first_name }} {{ comment.user.surname }} wrote:
                  </b>
                  <p class="comment-body mb-0">{{ comment.contents }}</p>
                </div>
                {% else %}
                <p class="text-muted mb-0">No comments have been posted for this event yet. Post a comment if you want to be the first comment.</p>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endblock %}